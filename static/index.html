<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ² æ™ºèƒ½ç«é”…ç‚¹é¤é¡¾é—® + RAG</title>
  <style>
    :root {
      --primary: #e74c3c;
      --primary-dark: #c0392b;
      --bg: #faf7f5;
      --card: #ffffff;
      --text: #2c3e50;
      --text-light: #7f8c8d;
      --border: #ecf0f1;
      --user-bubble: #e74c3c;
      --ai-bubble: #f8f9fa;
      --shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC',
                   'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary), #e67e22);
      color: #fff;
      padding: 16px 24px;
      text-align: center;
      box-shadow: var(--shadow);
      flex-shrink: 0;
    }
    header h1 { font-size: 1.3rem; font-weight: 600; }
    header p { font-size: 0.8rem; opacity: 0.85; margin-top: 4px; }

    /* Chat area */
    #chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.6;
      font-size: 0.95rem;
      word-break: break-word;
      white-space: pre-wrap;
      animation: fadeIn 0.25s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg.user {
      align-self: flex-end;
      background: var(--user-bubble);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg.ai {
      align-self: flex-start;
      background: var(--ai-bubble);
      color: var(--text);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }
    .source-tag {
      display: inline-block;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 10px;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .source-tag.rag {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .source-tag.concierge {
      background: #fff3e0;
      color: #e65100;
    }

    .msg.system {
      align-self: center;
      background: transparent;
      color: var(--text-light);
      font-size: 0.82rem;
      padding: 4px 12px;
    }

    /* Order JSON */
    .order-card {
      align-self: flex-start;
      background: #fff;
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 16px;
      max-width: 90%;
      overflow-x: auto;
      animation: fadeIn 0.3s ease;
    }
    .order-card summary {
      font-weight: 600;
      cursor: pointer;
      color: var(--primary);
      margin-bottom: 8px;
    }
    .order-card pre {
      font-size: 0.82rem;
      line-height: 1.5;
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
    }

    /* Input bar */
    #input-bar {
      flex-shrink: 0;
      display: flex;
      gap: 10px;
      padding: 12px 16px;
      background: var(--card);
      border-top: 1px solid var(--border);
      box-shadow: 0 -2px 8px rgba(0,0,0,0.04);
    }
    #input-bar input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 24px;
      font-size: 1rem;
      outline: none;
      transition: border 0.2s;
    }
    #input-bar input:focus { border-color: var(--primary); }
    #input-bar button {
      padding: 12px 24px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 24px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    #input-bar button:hover { background: var(--primary-dark); }
    #input-bar button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Quick actions */
    #quick-actions {
      display: flex;
      gap: 8px;
      padding: 8px 16px;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    .quick-btn {
      padding: 6px 14px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 0.82rem;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text);
    }
    .quick-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: #fef5f5;
    }

    /* Typing indicator */
    .typing {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 12px 16px;
    }
    .typing span {
      width: 8px; height: 8px;
      background: #bbb;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Scrollbar */
    #chat-area::-webkit-scrollbar { width: 6px; }
    #chat-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
  </style>
</head>
<body>

<header>
  <h1>ğŸ² æ™ºèƒ½ç«é”…ç‚¹é¤é¡¾é—®</h1>
  <p>RAG çŸ¥è¯†é—®ç­” + æ™ºèƒ½ç‚¹é¤é¡¾é—® â€” æœ‰é—®å¿…ç­”ï¼Œé‡èº«æ¨è</p>
</header>

<div id="chat-area">
  <div class="msg system">æ¬¢è¿å…‰ä¸´ï¼æ‚¨å¯ä»¥æé—®ç«é”…çŸ¥è¯†ï¼ˆå¦‚ã€Œè‚¥ç‰›æ¶®å¤šä¹…æœ€å¥½ï¼Ÿã€ï¼‰ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç‚¹é¤ï¼ˆå¦‚ã€Œå¾®è¾£ã€ä¸åƒç¾Šè‚‰ã€é¢„ç®—200å…ƒã€4ä¸ªäººã€ï¼‰ã€‚</div>
</div>

<div id="quick-actions">
  <button class="quick-btn" data-msg="è‚¥ç‰›æ¶®å¤šä¹…æœ€å¥½åƒï¼Ÿ">ğŸ” æ¶®è‚‰æŠ€å·§</button>
  <button class="quick-btn" data-msg="ç•ªèŒ„é”…é€‚åˆå‡è‚¥å—ï¼Ÿ">ğŸ” é”…åº•çŸ¥è¯†</button>
  <button class="quick-btn" data-msg="è˜¸æ–™æ€ä¹ˆè°ƒæœ€å¥½åƒï¼Ÿ">ğŸ” è˜¸æ–™æ¨è</button>
  <button class="quick-btn" data-msg="å¾®è¾£ã€ä¸åƒç¾Šè‚‰ã€é¢„ç®—200å…ƒã€4ä¸ªäºº">ğŸ² 4äººå¾®è¾£å¥—é¤</button>
  <button class="quick-btn" data-msg="å˜æ€è¾£ã€é¢„ç®—150å…ƒã€3ä¸ªäºº">ğŸ² 3äººå˜æ€è¾£</button>
  <button class="quick-btn" data-msg="ç¡®è®¤">âœ… ç¡®è®¤ä¸‹å•</button>
</div>

<form id="input-bar" autocomplete="off">
  <input id="user-input" type="text" placeholder="è¯·è¾“å…¥æ‚¨çš„éœ€æ±‚â€¦" autofocus />
  <button type="submit" id="send-btn">å‘é€</button>
</form>

<script>
const chatArea = document.getElementById('chat-area');
const userInput = document.getElementById('user-input');
const sendBtn   = document.getElementById('send-btn');
const form      = document.getElementById('input-bar');

let sessionId = null;

function scrollToBottom() {
  chatArea.scrollTop = chatArea.scrollHeight;
}

function addMessage(text, role, source) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  if (role === 'ai' && source && source !== 'system') {
    const tag = document.createElement('span');
    tag.className = `source-tag ${source}`;
    tag.textContent = source === 'rag' ? 'RAG çŸ¥è¯†åº“' : 'ç‚¹é¤é¡¾é—®';
    div.appendChild(tag);
    div.appendChild(document.createElement('br'));
  }
  div.appendChild(document.createTextNode(text));
  chatArea.appendChild(div);
  scrollToBottom();
}

function addOrderCard(json) {
  const card = document.createElement('details');
  card.className = 'order-card';
  card.open = true;
  const summary = document.createElement('summary');
  summary.textContent = 'ğŸ“‹ ç»“æ„åŒ–è®¢å•ï¼ˆç‚¹å‡»å±•å¼€/æ”¶èµ·ï¼‰';
  const pre = document.createElement('pre');
  pre.textContent = JSON.stringify(json, null, 2);
  card.appendChild(summary);
  card.appendChild(pre);
  chatArea.appendChild(card);
  scrollToBottom();
}

function showTyping() {
  const div = document.createElement('div');
  div.className = 'msg ai typing';
  div.id = 'typing-indicator';
  div.innerHTML = '<span></span><span></span><span></span>';
  chatArea.appendChild(div);
  scrollToBottom();
}

function removeTyping() {
  const el = document.getElementById('typing-indicator');
  if (el) el.remove();
}

async function sendMessage(text) {
  if (!text.trim()) return;

  addMessage(text, 'user');
  userInput.value = '';
  sendBtn.disabled = true;
  showTyping();

  try {
    const body = { message: text };
    if (sessionId) body.session_id = sessionId;

    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    sessionId = data.session_id;

    removeTyping();
    addMessage(data.reply, 'ai', data.source);

    if (data.order_json) {
      addOrderCard(data.order_json);
    }
  } catch (err) {
    removeTyping();
    addMessage(`ç½‘ç»œé”™è¯¯ï¼š${err.message}ï¼Œè¯·ç¨åé‡è¯•ã€‚`, 'system');
  } finally {
    sendBtn.disabled = false;
    userInput.focus();
  }
}

form.addEventListener('submit', (e) => {
  e.preventDefault();
  sendMessage(userInput.value);
});

document.querySelectorAll('.quick-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    sendMessage(btn.dataset.msg);
  });
});
</script>

</body>
</html>
